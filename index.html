<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarifs Officiels DIGIYLYFE ‚Äî Grille V2</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px; color:#1e293b;
    }
    .container{max-width:1200px;margin:0 auto}
    header{
      text-align:center; padding:40px 20px;
      background:rgba(255,255,255,.95);
      border-radius:24px; margin-bottom:30px;
      box-shadow:0 20px 60px rgba(0,0,0,.2);
    }
    h1{
      font-size:48px; font-weight:900;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text; margin-bottom:10px;
    }
    .tagline{font-size:20px;font-weight:800;color:#64748b;margin-bottom:14px}
    .subtag{font-size:14px;font-weight:700;color:#475569;opacity:.9}

    .notice{
      margin:18px auto 0;
      max-width:980px;
      background:#0f172a;
      color:#fff;
      border-radius:16px;
      padding:16px 18px;
      text-align:left;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .notice h3{font-size:16px;font-weight:900;margin-bottom:6px;color:#facc15}
    .notice p{font-size:13px;line-height:1.55;color:rgba(255,255,255,.88)}
    .pill-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
    }
    .pill b{color:#facc15}

    .contact-info{
      margin-top:20px; padding:20px;
      background:linear-gradient(135deg,#10b981 0%,#059669 100%);
      border-radius:16px; color:white;
    }
    .contact-info h3{font-size:24px;font-weight:900;margin-bottom:10px}
    .contact-details{font-size:18px;font-weight:900;margin-bottom:14px}
    .pay-button{
      display:inline-block; padding:16px 40px;
      background:#facc15; color:#1e293b; text-decoration:none;
      font-size:18px; font-weight:900; border-radius:12px;
      transition:all .3s; box-shadow:0 8px 16px rgba(250,204,21,.4);
    }
    .pay-button:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(250,204,21,.6);background:#fbbf24}

    .section-title{
      font-size:34px; font-weight:900; color:white; text-align:center;
      margin:40px 0 24px 0;
      text-shadow:0 4px 8px rgba(0,0,0,.3);
    }

    .modules-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
      gap:24px; margin-bottom:30px;
    }
    .module-card{
      background:rgba(255,255,255,.95);
      border-radius:20px; padding:30px;
      box-shadow:0 12px 40px rgba(0,0,0,.15);
      transition:all .3s;
      position:relative;
      overflow:hidden;
    }
    .module-card:hover{transform:translateY(-8px);box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .module-icon{font-size:48px;margin-bottom:15px}
    .module-title{font-size:26px;font-weight:900;color:#1e293b;margin-bottom:10px}
    .module-description{font-size:14px;font-weight:700;color:#64748b;line-height:1.6;margin-bottom:18px}

    .price-badge{
      display:inline-block; padding:12px 18px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white; font-size:20px; font-weight:900;
      border-radius:12px; margin-bottom:12px;
    }

    .tiers-container{
      background:#f1f5f9; border-radius:12px; padding:18px; margin-top:12px;
    }
    .tiers-title{
      font-size:13px; font-weight:900; color:#334155;
      margin-bottom:10px; text-transform:uppercase; letter-spacing:.6px;
    }
    .tier{
      background:white; padding:12px 14px; border-radius:10px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      border-left:4px solid #667eea;
    }
    .tier:last-child{margin-bottom:0}
    .tier-name{font-size:13px;font-weight:800;color:#334155}
    .tier-price{font-size:14px;font-weight:900;color:#667eea}

    .features{list-style:none;margin-top:14px}
    .features li{
      font-size:13px; font-weight:700; color:#475569;
      padding:7px 0 7px 24px; position:relative;
    }
    .features li::before{
      content:"‚úì"; position:absolute; left:0;
      color:#10b981; font-weight:900; font-size:16px;
    }
    .commission-badge{
      display:inline-block; padding:8px 14px;
      background:linear-gradient(135deg,#10b981 0%,#059669 100%);
      color:white; font-size:12px; font-weight:900;
      border-radius:999px; margin-top:10px;
    }

    .deal-badge{
      display:inline-block; padding:8px 12px;
      background:rgba(250,204,21,.15);
      border:1px solid rgba(250,204,21,.35);
      color:#7c5f00;
      font-size:12px; font-weight:900;
      border-radius:999px; margin-top:10px;
    }

    .banner{
      margin-top:18px;
      background:rgba(255,255,255,.9);
      border:2px dashed rgba(99,102,241,.35);
      border-radius:18px;
      padding:16px 18px;
      box-shadow:0 10px 28px rgba(0,0,0,.12);
    }
    .banner h3{font-size:18px;font-weight:900;color:#1e293b;margin-bottom:6px}
    .banner p{font-size:13px;font-weight:700;color:#475569;line-height:1.55}
    .banner ul{margin-top:10px;padding-left:18px}
    .banner li{margin:6px 0;font-size:13px;font-weight:800;color:#334155}
    .banner b{color:#0f172a}

    /* ‚úÖ SUPPL√âMENTS EXPLORE */
    .addon-wrap{
      background:rgba(255,255,255,.95);
      border-radius:24px;
      padding:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.18);
      margin: 8px 0 26px;
    }
    .addon-top{
      display:flex; gap:14px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .addon-top h2{
      font-size:22px; font-weight:950; color:#0f172a;
    }
    .addon-meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:12px; font-weight:900; color:#334155;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid rgba(2,6,23,.08);
    }
    .chip b{color:#0f172a}

    .addon-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:16px;
      margin-top:12px;
    }
    .addon-card{
      background:#0f172a;
      color:#fff;
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:0 12px 36px rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    .addon-card h3{font-size:16px;font-weight:950;margin-bottom:6px;color:#facc15}
    .addon-card p{font-size:13px;line-height:1.55;color:rgba(255,255,255,.86)}
    .addon-row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:12px;
    }
    .addon-price{
      font-size:20px; font-weight:1000;
      color:#22c55e;
    }
    .btn-addon{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:12px 14px;
      border-radius:12px;
      font-weight:950;
      text-decoration:none;
      background:#facc15;
      color:#0f172a;
      border:0;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(250,204,21,.25);
    }
    .btn-addon:hover{filter:brightness(.98); transform:translateY(-1px)}
    .btn-addon.secondary{
      background:rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:none;
    }
    .status-pill{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#fff;
    }
    .status-pill.active{border-color:rgba(34,197,94,.45); color:#86efac}
    .status-pill.paused{border-color:rgba(245,158,11,.45); color:#fde68a}
    .status-pill.canceled{border-color:rgba(239,68,68,.45); color:#fecaca}
    .status-pill.none{border-color:rgba(148,163,184,.35); color:#e2e8f0}

    .lockbox{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px dashed rgba(250,204,21,.45);
      background: rgba(250,204,21,.12);
      color:#0f172a;
      font-size:12px;
      font-weight:950;
      line-height:1.45;
    }

    @media(max-width:768px){
      h1{font-size:32px}
      .tagline{font-size:16px}
      .modules-grid{grid-template-columns:1fr}
      .module-title{font-size:22px}
      .price-badge{font-size:18px}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ü¶Ö DIGIYLYFE</h1>
      <p class="tagline">Grille Officielle V2 ‚Ä¢ 0% Commission ‚Ä¢ Paiement direct au Pro</p>
      <p class="subtag">Tarifs pens√©s terrain S√©n√©gal ‚Ä¢ Simples ‚Ä¢ Progressifs ‚Ä¢ Justes</p>

      <div class="notice">
        <h3>üî• Offres Officielles DIGIY ‚Äî V2</h3>
        <p>
          Abonnement mensuel (modules). Et si tu veux la mise en avant EXPLORE :
          <b>les Suppl√©ments EXPLORE sont payants</b> (mise en page vitrine + visibilit√© + WhatsApp direct).
        </p>
        <div class="pill-row">
          <div class="pill">üéÅ <b>Droit d‚Äôentr√©e OFFERT</b> si paiement <b>annuel</b> (modules)</div>
          <div class="pill">üíé <b>-10%</b> si <b>Multi-Modules</b> (2+ modules actifs)</div>
          <div class="pill">‚úÖ Toujours <b>0% commission</b></div>
        </div>
      </div>

      <div class="contact-info">
        <h3>üí≥ Paiement & Contact</h3>
        <div class="contact-details">
          üë§ JB BEAUVILLE<br>
          üìû +221 77 134 28 89
        </div>
        <a href="https://beauville.github.io/commencer-a-payer/" class="pay-button">
          üí∞ COMMENCER √Ä PAYER
        </a>
      </div>

      <div class="banner">
        <h3>üìå R√®gles simples (pas de palabres üòÑ)</h3>
        <p><b>Mensuel</b> = outil actif. <b>Annuel</b> = meilleur prix + onboarding offert (modules).</p>
        <ul>
          <li><b>Annuel</b> : paiement 12 mois ‚Üí <b>Droit d‚Äôentr√©e OFFERT</b></li>
          <li><b>Multi-modules</b> : 2+ modules ‚Üí <b>-10% sur mensualit√©s</b></li>
          <li><b>0% commission</b> : le pro garde l‚Äôargent.</li>
        </ul>
      </div>

      <div class="notice" style="margin-top:18px">
        <h3>üß© Contexte Pro (pour voir Statut Suppl√©ments)</h3>
        <p>
          Ouvre avec :
          <span class="pill"><b>?phone=+221...</b></span>
          <span class="pill"><b>&slug=chez-...</b></span>
          <span class="pill"><b>&module=LOC</b></span>
        </p>
      </div>
    </header>

    <!-- (TES MODULES ICI : inchang√©s ‚Äî tu peux garder exactement tes cards comme avant) -->
    <!-- ... -->

    <!-- ‚úÖ SUPPL√âMENTS EXPLORE (AUTO depuis ta table) -->
    <div class="section-title">‚ú® Suppl√©ments EXPLORE (payants)</div>

    <div class="addon-wrap">
      <div class="addon-top">
        <h2>üß≠ EXPLORE ‚Äî Mise en avant vitrine</h2>
        <div class="addon-meta">
          <span class="chip">üì± phone: <b id="ctxPhone">‚Äî</b></span>
          <span class="chip">üè∑Ô∏è slug: <b id="ctxSlug">‚Äî</b></span>
          <span class="chip">üì¶ module actif: <b id="ctxPrimary">‚Äî</b></span>
        </div>
      </div>

      <div class="lockbox" id="lockBox" style="display:none;">
        üîí Pour activer un suppl√©ment EXPLORE, il faut d√©j√† avoir <b>au moins 1 module PRO actif</b> (LOC, MARKET, DRIVER, POS, etc).
      </div>

      <div class="addon-grid" id="addonsGrid"></div>
    </div>

    <!-- Contact final -->
    <header style="margin-top:40px;">
      <h2 style="color:#1e293b; margin-bottom:20px;">üí≥ Pr√™t √† commencer ?</h2>
      <div class="contact-info">
        <h3>Contacte JB BEAUVILLE</h3>
        <div class="contact-details">
          üìû +221 77 134 28 89<br>
          üí¨ WhatsApp disponible
        </div>
        <a href="https://beauville.github.io/commencer-a-payer/" class="pay-button">
          üöÄ COMMENCER √Ä PAYER MAINTENANT
        </a>
      </div>
    </header>
  </div>

  <script>
    (function(){
      "use strict";

      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const $ = (id)=>document.getElementById(id);
      function qs(name){
        try{ return new URL(location.href).searchParams.get(name) || ""; }catch(e){ return ""; }
      }
      function normPhone(p){
        p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
        if(p.startsWith("00221")) p = "+221" + p.slice(5);
        if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
        if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
        return p;
      }
      function fmt(n){
        n = Number(n||0);
        if(!isFinite(n) || n<=0) return "‚Äî";
        return n.toLocaleString("fr-FR");
      }
      function esc(s){
        s = String(s ?? "");
        return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      const phone = normPhone(qs("phone"));
      const slug  = (qs("slug") || "").trim();
      const primaryFromQS = (qs("module") || "LOC").trim().toUpperCase();

      $("ctxPhone").textContent = phone || "‚Äî";
      $("ctxSlug").textContent  = slug  || "‚Äî";

      let resolvedPrimary = primaryFromQS;

      async function isActive(mod){
        try{
          if(!phone) return false;
          const r = await sb.rpc("is_module_active", { p_phone: phone, p_module: String(mod||"").toUpperCase() });
          if(r.error) return false;
          return !!r.data;
        }catch(e){ return false; }
      }

      async function resolvePrimaryModule(){
        if(!phone) return { ok:false, mod: primaryFromQS || "LOC" };

        if(await isActive(primaryFromQS)) return { ok:true, mod: primaryFromQS };

        const candidates = ["LOC","MARKET","DRIVER","POS_PRO","RESTO_PRO","RESTO_RESA","JOBS","BUILD"];
        for(const m of candidates){
          if(await isActive(m)) return { ok:true, mod: m };
        }
        return { ok:false, mod: primaryFromQS || "LOC" };
      }

      function statusClass(s){
        s = String(s||"none").toLowerCase();
        if(s==="active") return "active";
        if(s==="paused") return "paused";
        if(s==="canceled") return "canceled";
        return "none";
      }

      function buildPayLink(addonModule, addonPlan, price){
        const PAY_PAGE = "https://beauville.github.io/commencer-a-payer/";
        const u = new URL(PAY_PAGE);

        if(phone) u.searchParams.set("phone", phone);
        if(slug)  u.searchParams.set("slug", slug);

        // module d‚Äôacc√®s (module actif)
        u.searchParams.set("module", resolvedPrimary || "LOC");

        // suppl√©ment
        u.searchParams.set("kind", "addon");

        // ‚úÖ IMPORTANT : m EXACT comme ta table (minuscule)
        u.searchParams.set("m", String(addonModule||""));
        u.searchParams.set("plan", String(addonPlan||""));
        u.searchParams.set("amount", String(price||""));

        u.searchParams.set("from", location.href);
        return u.toString();
      }

      function cardHTML(x){
        const price = Number(x.price_month_fcfa || 0);
        const st = String(x.addon_status || "none");

        const btnLabel =
          (st==="active") ? "‚úÖ D√©j√† actif (g√©rer)" :
          (st==="paused") ? "‚è∏Ô∏è Reprendre / Payer" :
          (st==="canceled") ? "‚ôªÔ∏è R√©activer / Payer" :
          "üí≥ Activer / Payer";

        const link = buildPayLink(x.module, x.plan_code, price);

        return `
          <div class="addon-card">
            <h3>${esc((x.module||"") + " ‚Ä¢ " + (x.plan_code||""))}</h3>
            <p>${esc(x.description || "Suppl√©ment EXPLORE")}</p>

            <div class="addon-row">
              <div class="addon-price">${fmt(price)} FCFA / mois</div>
              <span class="status-pill ${statusClass(st)}">statut: ${esc(st)}</span>
            </div>

            <div class="addon-row" style="margin-top:14px">
              <a class="btn-addon" href="${link}">${btnLabel}</a>
              <button class="btn-addon secondary" type="button" data-refresh="1">üîÑ Rafra√Æchir</button>
            </div>

            <p style="margin-top:12px;font-size:12px;color:rgba(255,255,255,.86);line-height:1.45">
              Suppl√©ment <b>payant</b> : mise en avant vitrine EXPLORE (manuel ‚Üí Wave + re√ßu WhatsApp).
            </p>
          </div>
        `;
      }

      async function loadAddons(){
        const grid = $("addonsGrid");
        grid.innerHTML = "";

        const plans = await sb
          .from("digiy_pricing_plans")
          .select("module, plan_code, description, price_month_fcfa, is_active")
          .in("module", ["explore","explore_boost"])
          .eq("is_active", true)
          .order("module", { ascending:true })
          .order("price_month_fcfa", { ascending:true });

        if(plans.error){
          console.error(plans.error);
          grid.innerHTML = `<div class="addon-card"><h3>Erreur</h3><p>Impossible de charger les suppl√©ments.</p></div>`;
          return;
        }

        const rows = plans.data || [];

        // status (si phone)
        if(phone){
          for(const r of rows){
            try{
              const st = await sb
                .from("digiy_subscription_addons")
                .select("status, price_monthly_fcfa, updated_at")
                .eq("phone", phone)
                .eq("primary_module", resolvedPrimary)
                .eq("addon_module", r.module)
                .eq("addon_plan", r.plan_code)
                .order("updated_at", { ascending:false })
                .limit(1)
                .maybeSingle();

              if(!st.error && st.data){
                r.addon_status = st.data.status || "none";
                const p = Number(st.data.price_monthly_fcfa || 0);
                if(p>0) r.price_month_fcfa = p;
              }else{
                r.addon_status = "none";
              }
            }catch(e){
              r.addon_status = "none";
            }
          }
        }else{
          rows.forEach(r=>r.addon_status="none");
        }

        grid.innerHTML = rows.map(cardHTML).join("");

        grid.querySelectorAll('[data-refresh="1"]').forEach(btn=>{
          btn.addEventListener("click", refreshAll);
        });
      }

      async function refreshAll(){
        const res = await resolvePrimaryModule();
        resolvedPrimary = res.mod;

        $("ctxPrimary").textContent = res.ok ? resolvedPrimary : "‚Äî";
        $("lockBox").style.display = res.ok ? "none" : "block";

        await loadAddons();
      }

      // boot
      refreshAll();
    })();
  </script>
</body>
</html>
